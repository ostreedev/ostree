

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <link rel="stylesheet" href="/ostree/assets/css/just-the-docs-default.css">

  

  
    <script src="/ostree/assets/js/vendor/lunr.min.js"></script>
  

  

  <script src="/ostree/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Writing a buildsystem and managing repositories | ostreedev/ostree</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Writing a buildsystem and managing repositories" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ostree documentation" />
<meta property="og:description" content="ostree documentation" />
<link rel="canonical" href="https://ostreedev.github.io/ostree/buildsystem-and-repos/" />
<meta property="og:url" content="https://ostreedev.github.io/ostree/buildsystem-and-repos/" />
<meta property="og:site_name" content="ostreedev/ostree" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Writing a buildsystem and managing repositories" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"ostree documentation","headline":"Writing a buildsystem and managing repositories","url":"https://ostreedev.github.io/ostree/buildsystem-and-repos/"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <a class="skip-to-main" href="#main-content">Skip to main content</a>
  <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="svg-link" viewBox="0 0 24 24">
  <title>Link</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
  </svg>
</symbol>

  <symbol id="svg-menu" viewBox="0 0 24 24">
  <title>Menu</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</symbol>

  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
  <title>Expand</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
    <polyline points="9 18 15 12 9 6"></polyline>
  </svg>
</symbol>

  <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE -->
<symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link">
  <title id="svg-external-link-title">(external link)</title>
  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line>
</symbol>

  
    <symbol id="svg-doc" viewBox="0 0 24 24">
  <title>Document</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
  </svg>
</symbol>

    <symbol id="svg-search" viewBox="0 0 24 24">
  <title>Search</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
</symbol>

  
  
    <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md -->
<symbol id="svg-copy" viewBox="0 0 16 16">
  <title>Copy</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
  </svg>
</symbol>
<symbol id="svg-copied" viewBox="0 0 16 16">
  <title>Copied</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16">
    <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/>
    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/>
  </svg>
</symbol>

  
</svg>

  <div class="side-bar">
  <div class="site-header">
    <a href="/ostree/" class="site-title lh-tight">
  ostreedev/ostree

</a>
    <a href="#" id="menu-button" class="site-button">
      <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
    </a>
  </div>
  <nav aria-label="Main" id="site-nav" class="site-nav">
    
    
      <ul class="nav-list"><li class="nav-list-item"><a href="/ostree/" class="nav-list-link">libostree</a></li><li class="nav-list-item"><a href="/ostree/introduction/" class="nav-list-link">OSTree Overview</a></li><li class="nav-list-item"><a href="/ostree/repo/" class="nav-list-link">Anatomy of an OSTree repository</a></li><li class="nav-list-item"><a href="/ostree/deployment/" class="nav-list-link">Deployments</a></li><li class="nav-list-item"><a href="/ostree/atomic-upgrades/" class="nav-list-link">Atomic Upgrades</a></li><li class="nav-list-item"><a href="/ostree/atomic-rollbacks/" class="nav-list-link">Atomic Rollbacks</a></li><li class="nav-list-item"><a href="/ostree/adapting-existing/" class="nav-list-link">Adapting existing mainstream distributions</a></li><li class="nav-list-item"><a href="/ostree/var/" class="nav-list-link">OSTree and /var handling</a></li><li class="nav-list-item"><a href="/ostree/formats/" class="nav-list-link">OSTree data formats</a></li><li class="nav-list-item active"><a href="/ostree/buildsystem-and-repos/" class="nav-list-link active">Writing a buildsystem and managing repositories</a></li><li class="nav-list-item"><a href="/ostree/authenticated-repos/" class="nav-list-link">Handling access to authenticated remote repositories</a></li><li class="nav-list-item"><a href="/ostree/repository-management/" class="nav-list-link">Managing content in OSTree repositories</a></li><li class="nav-list-item"><a href="/ostree/copying-deltas/" class="nav-list-link">Static deltas for offline updates</a></li><li class="nav-list-item"><a href="/ostree/ima/" class="nav-list-link">Using Linux IMA with OSTree</a></li><li class="nav-list-item"><a href="/ostree/related-projects/" class="nav-list-link">Related Projects</a></li><li class="nav-list-item"><a href="/ostree/composefs/" class="nav-list-link">Using composefs with OSTree</a></li><li class="nav-list-item"><a href="/ostree/bootloaders/" class="nav-list-link">Bootloaders</a></li><li class="nav-list-item"><a href="/ostree/CONTRIBUTING/" class="nav-list-link">Contributing</a></li><li class="nav-list-item"><a href="/ostree/contributing-tutorial/" class="nav-list-link">OSTree Contributing Tutorial</a></li><li class="nav-list-item"><a href="/ostree/README-historical/" class="nav-list-link">Historical OSTree README</a></li></ul>
    
  </nav>

  
  
    <footer class="site-footer">
      This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.
    </footer>
  
</div>

  <div class="main" id="top">
    <div id="main-header" class="main-header">
  
    

<div class="search">
  <div class="search-input-wrap">
    <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search ostreedev/ostree" aria-label="Search ostreedev/ostree" autocomplete="off">
    <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
  </div>
  <div id="search-results" class="search-results"></div>
</div>

  
  
  
    <nav aria-label="Auxiliary" class="aux-nav">
  <ul class="aux-nav-list">
    
      <li class="aux-nav-list-item">
        <a href="https://github.com/ostreedev/ostree" class="site-button"
          
        >
          OSTree on GitHub
        </a>
      </li>
    
  </ul>
</nav>

  
</div>

    <div id="main-content-wrap" class="main-content-wrap">
      
  


      <div id="main-content" class="main-content" role="main">
        
          <h1 class="no_toc" id="writing-a-buildsystem-and-managing-repositories">
  
  
    <a href="#writing-a-buildsystem-and-managing-repositories" class="anchor-heading" aria-labelledby="writing-a-buildsystem-and-managing-repositories"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing a buildsystem and managing repositories
  
  
</h1>
    

<ol id="markdown-toc">
  <li><a href="#build-vs-buy" id="markdown-toc-build-vs-buy">Build vs buy</a></li>
  <li><a href="#initializing" id="markdown-toc-initializing">Initializing</a></li>
  <li><a href="#writing-your-own-ostree-buildsystem" id="markdown-toc-writing-your-own-ostree-buildsystem">Writing your own OSTree buildsystem</a></li>
  <li><a href="#constructing-trees-from-unions" id="markdown-toc-constructing-trees-from-unions">Constructing trees from unions</a></li>
  <li><a href="#migrating-content-between-repositories" id="markdown-toc-migrating-content-between-repositories">Migrating content between repositories</a></li>
  <li><a href="#more-sophisticated-repository-management" id="markdown-toc-more-sophisticated-repository-management">More sophisticated repository management</a></li>
</ol>

<!-- SPDX-License-Identifier: (CC-BY-SA-3.0 OR GFDL-1.3-or-later) -->

<p>OSTree is not a package system.  It does not directly support building
source code.  Rather, it is a tool for transporting and managing
content, along with package-system independent aspects like bootloader
management for updates.</p>

<p>We’ll assume here that we’re planning to generate commits on a build
server, then have client systems replicate it.  Doing client-side
assembly is also possible of course, but this discussion will focus
primarily on server-side concerns.</p>
<h2 id="build-vs-buy">
  
  
    <a href="#build-vs-buy" class="anchor-heading" aria-labelledby="build-vs-buy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build vs buy
  
  
</h2>
    

<p>Therefore, you need to either pick an existing tool for writing
content into an OSTree repository, or write your own.  An example
tool is <a href="https://github.com/coreos/rpm-ostree">rpm-ostree</a> - it
takes as input RPMs, and commits them (currently oriented for
server-side, but aiming to do client-side too).</p>
<h2 id="initializing">
  
  
    <a href="#initializing" class="anchor-heading" aria-labelledby="initializing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Initializing
  
  
</h2>
    

<p>For this initial discussion, we’re assuming you have a single
<code class="language-plaintext highlighter-rouge">archive</code> repository:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir repo
ostree --repo=repo init --mode=archive
</code></pre></div></div>

<p>You can export this via a static webserver, and configure clients to
pull from it.</p>
<h2 id="writing-your-own-ostree-buildsystem">
  
  
    <a href="#writing-your-own-ostree-buildsystem" class="anchor-heading" aria-labelledby="writing-your-own-ostree-buildsystem"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing your own OSTree buildsystem
  
  
</h2>
    

<p>There exist many, many systems that basically follow this pattern:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$pkg --installroot=/path/to/tmpdir install foo bar baz
$imagesystem commit --root=/path/to/tmpdir
</code></pre></div></div>

<p>For various values of <code class="language-plaintext highlighter-rouge">$pkg</code> such as <code class="language-plaintext highlighter-rouge">yum</code>, <code class="language-plaintext highlighter-rouge">apt-get</code>, etc., and
values of <code class="language-plaintext highlighter-rouge">$imagesystem</code> could be simple tarballs, Amazon Machine
Images, ISOs, etc.</p>

<p>Now obviously in this document, we’re going to talk about the
situation where <code class="language-plaintext highlighter-rouge">$imagesystem</code> is OSTree.  The general idea with
OSTree is that wherever you might store a series of tarballs for
applications or OS images, OSTree is likely going to be better.  For
example, it supports GPG signatures, binary deltas, writing bootloader
configuration, etc.</p>

<p>OSTree does not include a package/component build system simply
because there already exist plenty of good ones - rather, it is
intended to provide an infrastructure layer.</p>

<p>The above mentioned <code class="language-plaintext highlighter-rouge">rpm-ostree compose tree</code> chooses RPM as the value
of <code class="language-plaintext highlighter-rouge">$pkg</code> - so binaries are built as RPMs, then committed as a whole
into an OSTree commit.</p>

<p>But let’s discuss building our own.  If you’re just experimenting,
it’s quite easy to start with the command line.  We’ll assume for this
purpose that you have a build process that outputs a directory tree -
we’ll call this tool <code class="language-plaintext highlighter-rouge">$pkginstallroot</code> (which could be <code class="language-plaintext highlighter-rouge">yum
--installroot</code> or <code class="language-plaintext highlighter-rouge">debootstrap</code>, etc.).</p>

<p>Your initial prototype is going to look like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$pkginstallroot /path/to/tmpdir
ostree --repo=repo commit -s 'build' -b exampleos/x86_64/standard --tree=dir=/path/to/tmpdir
</code></pre></div></div>

<p>Alternatively, if your build system can generate a tarball, you can
commit that tarball into OSTree.  For example,
<a href="http://www.openembedded.org/">OpenEmbedded</a> can output a tarball, and
one can commit it via:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ostree commit -s 'build' -b exampleos/x86_64/standard --tree=tar=myos.tar
</code></pre></div></div>
<h2 id="constructing-trees-from-unions">
  
  
    <a href="#constructing-trees-from-unions" class="anchor-heading" aria-labelledby="constructing-trees-from-unions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Constructing trees from unions
  
  
</h2>
    

<p>The above is a very simplistic model, and you will quickly notice that
it’s slow.  This is because OSTree has to re-checksum and recompress
the content each time it’s committed.  (Most of the CPU time is spent
in compression which gets thrown away if the content turns out to be
already stored).</p>

<p>A more advanced approach is to store components in OSTree itself, then
union them, and recommit them.  At this point, we recommend taking a
look at the OSTree API, and choose a programming language supported by
<a href="https://wiki.gnome.org/Projects/GObjectIntrospection">GObject Introspection</a>
to write your buildsystem scripts.  Python may be a good choice, or
you could choose custom C code, etc.</p>

<p>For the purposes of this tutorial we will use shell script, but it’s
strongly recommended to choose a real programming language for your
build system.</p>

<p>Let’s say that your build system produces separate artifacts (whether
those are RPMs, zip files, or whatever).  These artifacts should be
the result of <code class="language-plaintext highlighter-rouge">make install DESTDIR=</code> or similar.  Basically
equivalent to RPMs/debs.</p>

<p>Further, in order to make things fast, we will need a separate
<code class="language-plaintext highlighter-rouge">bare-user</code> repository in order to perform checkouts quickly via
hardlinks.  We’ll then export content into the <code class="language-plaintext highlighter-rouge">archive</code> repository
for use by client systems.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir build-repo
ostree --repo=build-repo init --mode=bare-user
</code></pre></div></div>

<p>You can begin committing those as individual branches:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ostree --repo=build-repo commit -b exampleos/x86_64/bash --tree=tar=bash-4.2-bin.tar.gz
ostree --repo=build-repo commit -b exampleos/x86_64/systemd --tree=tar=systemd-224-bin.tar.gz
</code></pre></div></div>

<p>Set things up so that whenever a package changes, you redo the
<code class="language-plaintext highlighter-rouge">commit</code> with the new package version - conceptually, the branch
tracks the individual package versions over time, and defaults to
“latest”.  This isn’t required - one could also include the version in
the branch name, and have metadata outside to determine “latest” (or
the desired version).</p>

<p>Now, to construct our final tree:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf exampleos-build
for package in bash systemd; do
  ostree --repo=build-repo checkout -U --union exampleos/x86_64/${package} exampleos-build
done
# Set up a "rofiles-fuse" mount point; this ensures that any processes
# we run for post-processing of the tree don't corrupt the hardlinks.
mkdir -p mnt
rofiles-fuse exampleos-build mnt
# Now run global "triggers", generate cache files:
ldconfig -r mnt
  (Insert other programs here)
fusermount -u mnt
ostree --repo=build-repo commit -b exampleos/x86_64/standard --link-checkout-speedup exampleos-build
</code></pre></div></div>

<p>There are a number of interesting things going on here.  The major
architectural change is that we’re using <code class="language-plaintext highlighter-rouge">--link-checkout-speedup</code>.
This is a way to tell OSTree that our checkout is made via hardlinks,
and to scan the repository in order to build up a reverse <code class="language-plaintext highlighter-rouge">(device,
inode) -&gt; checksum</code> mapping.</p>

<p>In order for this mapping to be accurate, we needed the <code class="language-plaintext highlighter-rouge">rofiles-fuse</code>
to ensure that any changed files had new inodes (and hence a new
checksum).</p>
<h2 id="migrating-content-between-repositories">
  
  
    <a href="#migrating-content-between-repositories" class="anchor-heading" aria-labelledby="migrating-content-between-repositories"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Migrating content between repositories
  
  
</h2>
    

<p>Now that we have content in our <code class="language-plaintext highlighter-rouge">build-repo</code> repository (in
<code class="language-plaintext highlighter-rouge">bare-user</code> mode), we need to move the <code class="language-plaintext highlighter-rouge">exampleos/x86_64/standard</code>
branch content into the repository just named <code class="language-plaintext highlighter-rouge">repo</code> (in <code class="language-plaintext highlighter-rouge">archive</code>
mode) for export, which will involve zlib compression of new objects.
We likely want to generate static deltas after that as well.</p>

<p>Let’s copy the content:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ostree --repo=repo pull-local build-repo exampleos/x86_64/standard
</code></pre></div></div>

<p>Clients can now incrementally download new objects - however, this
would also be a good time to generate a delta from the previous
commit.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ostree --repo=repo static-delta generate exampleos/x86_64/standard
</code></pre></div></div>
<h2 id="more-sophisticated-repository-management">
  
  
    <a href="#more-sophisticated-repository-management" class="anchor-heading" aria-labelledby="more-sophisticated-repository-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> More sophisticated repository management
  
  
</h2>
    

<p>Next, see <a href="/ostree/repository-management/">Repository Management</a> for the
next steps in managing content in OSTree repositories.</p>

        

        

        

  <hr>
  <footer>
    

    <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; <a href="https://www.redhat.com">Red Hat, Inc.</a> and <a href="https://github.com/ostreedev">others</a>.</p>

    
      <div class="d-flex mt-2">
        
        
          <p class="text-small text-grey-dk-000 mb-0">
            <a href="https://github.com/ostreedev/ostree/tree/main/docs/buildsystem-and-repos.md" id="edit-this-page">Edit this page on GitHub</a>
          </p>
        
      </div>
    
  </footer>



      </div>
    </div>
    
      

<div class="search-overlay"></div>

    
  </div>

  
</body>
</html>

